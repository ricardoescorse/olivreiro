<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Busca de Obras por Autor</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#111; --card:#f5f5f5; --accent:#2b7cff;
    }
    body.light{ background:var(--bg); color:var(--fg); }
    body.dark{ --bg:#121217; --fg:#e6e6e6; --card:#1b1b1f; --accent:#7aa2ff; background:var(--bg); color:var(--fg); }
    body{ font-family:Arial,Helvetica,sans-serif; margin:0; padding:20px; transition:background .2s, color .2s }
    header{ display:flex; gap:12px; align-items:center; margin-bottom:16px }
    input[type=text]{ padding:8px; font-size:16px; width:320px }
    button{ padding:8px 12px; font-size:14px; cursor:pointer }
    .controls{ margin-left:auto; display:flex; gap:8px }
    main{ display:grid; grid-template-columns:360px 1fr; gap:16px }
    .panel{ background:var(--card); padding:12px; border-radius:8px }
    select{ width:100%; height:300px; font-size:14px }
    img.cover{ max-width:200px; border-radius:4px; display:block }
    .meta{ margin-top:8px }
    .label{ font-weight:700 }
    a.source{ color:var(--accent) }
    /* Responsividade e ajustes visuais */
    body{ font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, Helvetica, sans-serif }
    select{ height: min(50vh, 420px) }
    img.cover{ max-width:280px }
    @media(max-width:800px){
      main{ grid-template-columns: 1fr; }
      header{ flex-wrap:wrap }
      input[type=text]{ width:100% }
    }
  </style>
</head>
<body class="light">
  <header>
    <h2>Pesquisar por autor</h2>
    <input id="authorInput" type="text" list="authorsDatalist" placeholder="Digite o nome do autor" autocomplete="off" />
    <datalist id="authorsDatalist"></datalist>
    <button id="showAllBtn" style="display:none; margin-left:6px;">Mostrar todas</button>
    <button id="searchBtn">Pesquisar</button>
    <div class="controls">
      <button id="lightBtn">claro</button>
      <button id="darkBtn">escuro</button>
    </div>
  </header>

  <main>
    <section class="panel">
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
        <strong>Obras encontradas</strong>
        <button id="resumoBtn">resumo</button>
      </div>
      <select id="worksList" size="12"></select>
      <div id="status" style="margin-top:8px;color:gray;font-size:13px"></div>
    </section>

    <section class="panel" id="details">
      <div style="display:flex; align-items:center; gap:8px; justify-content:space-between">
        <strong>Detalhes da obra</strong>
        <div><button id="exportBtn" disabled>Exportar JSON</button></div>
      </div>
      <div id="detailContent" style="margin-top:10px">
        <div style="color:gray">Selecione uma obra e clique em "resumo".</div>
      </div>
    </section>
  </main>

  <script>
    const searchBtn = document.getElementById('searchBtn');
    const authorInput = document.getElementById('authorInput');
    const worksList = document.getElementById('worksList');
    const resumoBtn = document.getElementById('resumoBtn');
    const detailContent = document.getElementById('detailContent');
    const status = document.getElementById('status');
    const lightBtn = document.getElementById('lightBtn');
    const darkBtn = document.getElementById('darkBtn');
    const showAllBtn = document.getElementById('showAllBtn');
    const exportBtn = document.getElementById('exportBtn');

    // Armazenar ids para consultas detalhadas
    let volumesCache = {};
    let lastShownVolume = null; // guarda o último volume exibido para exportar

    lightBtn.addEventListener('click', ()=> document.body.className='light');
    darkBtn.addEventListener('click', ()=> document.body.className='dark');

    searchBtn.addEventListener('click', ()=> searchAuthor());
    authorInput.addEventListener('keydown', (e)=> { if(e.key==='Enter') searchAuthor() });
    // Debounce helper to avoid many requests while typing
    function debounce(fn, wait){ let t=null; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); } }

    // Sugestões preditivas de autores usando Google Books
    async function suggestAuthors(){
      const q = authorInput.value.trim();
      const datalist = document.getElementById('authorsDatalist');
      datalist.innerHTML = '';
      showAllBtn.style.display = 'none';
      if(!q || q.length < 2) return;
      status.textContent = 'Buscando sugestões...';
      try{
        const url = 'https://www.googleapis.com/books/v1/volumes?q=' + encodeURIComponent('inauthor:' + q) + '&maxResults=20';
        const res = await fetch(url);
        const data = await res.json();
        if(!data.items || data.items.length===0){
          status.textContent = 'Nenhuma sugestão direta. Clique em "Mostrar todas" para ver todas as opções encontradas.';
          showAllBtn.style.display = 'inline-block';
          return
        }
        const authorsSet = new Set();
        data.items.forEach(it=>{ if(it.volumeInfo && it.volumeInfo.authors) it.volumeInfo.authors.forEach(a=>authorsSet.add(a)) });
        if(authorsSet.size === 0){
          status.textContent = 'Nenhuma sugestão direta. Clique em "Mostrar todas" para ver todas as opções encontradas.';
          showAllBtn.style.display = 'inline-block';
          return
        }
        // Se o usuário digitou algo errado, ofereça todas as opções encontradas
        authorsSet.forEach(a=>{ const opt = document.createElement('option'); opt.value = a; datalist.appendChild(opt) });
        status.textContent = `Sugestões encontradas: ${authorsSet.size}`;
      }catch(err){
        console.error(err);
        const msg = err && err.message ? err.message : String(err);
        status.textContent = 'Erro ao buscar sugestões: ' + msg;
        if(msg.includes('Failed to fetch') || msg.includes('NetworkError')) status.textContent += ' — verifique conexão ou CORS.';
      }
    }

    // Quando não houver correspondência direta, buscar todas as ocorrências relacionadas e mostrar autores
    async function showAllAuthors(){
      const q = authorInput.value.trim();
      const datalist = document.getElementById('authorsDatalist');
      datalist.innerHTML = '';
      showAllBtn.disabled = true;
      status.textContent = 'Buscando todas as ocorrências (pode demorar)...';
      try{
        const url = 'https://www.googleapis.com/books/v1/volumes?q=' + encodeURIComponent(q) + '&maxResults=40';
        const res = await fetch(url);
        const data = await res.json();
        if(!data.items || data.items.length===0){ status.textContent = 'Nenhuma obra encontrada para exibir autores.'; showAllBtn.style.display='none'; showAllBtn.disabled=false; return }
        const authorsSet = new Set();
        data.items.forEach(it=>{ if(it.volumeInfo && it.volumeInfo.authors) it.volumeInfo.authors.forEach(a=>authorsSet.add(a)) });
        if(authorsSet.size===0){ status.textContent='Nenhum autor encontrado.'; showAllBtn.style.display='none'; showAllBtn.disabled=false; return }
        authorsSet.forEach(a=>{ const opt = document.createElement('option'); opt.value = a; datalist.appendChild(opt) });
        status.textContent = `Autores encontrados: ${authorsSet.size}`;
      }catch(err){ console.error(err); status.textContent = 'Erro ao buscar todas as ocorrências.' }
      showAllBtn.disabled = false;
    }

    authorInput.addEventListener('input', debounce(suggestAuthors, 300));
    showAllBtn.addEventListener('click', showAllAuthors);

    resumoBtn.addEventListener('click', async ()=>{
      const id = worksList.value;
      if(!id){ alert('Selecione uma obra primeiro.'); return }
      await showDetails(id);
    });

    async function searchAuthor(){
      const author = authorInput.value.trim();
      worksList.innerHTML = '';
      detailContent.innerHTML = '<div style="color:gray">Selecione uma obra e clique em "resumo".</div>';
      volumesCache = {};
      if(!author){ status.textContent='Digite o nome de um autor.'; return }
      status.textContent = 'Buscando obras...';
      try{
        const url = 'https://www.googleapis.com/books/v1/volumes?q=' + encodeURIComponent('inauthor:' + author) + '&maxResults=40';
        const res = await fetch(url);
        const data = await res.json();
        if(!data.items || data.items.length===0){ status.textContent = 'Nenhuma obra encontrada.'; return }
        data.items.forEach(item=>{
          const opt = document.createElement('option');
          opt.value = item.id;
          const title = item.volumeInfo && item.volumeInfo.title ? item.volumeInfo.title : '(sem título)';
          const info = item.volumeInfo && item.volumeInfo.authors ? ' — ' + item.volumeInfo.authors.join(', ') : '';
          opt.textContent = title + info;
          worksList.appendChild(opt);
          volumesCache[item.id] = item; // cache inicial
        });
        status.textContent = `Encontrei ${data.items.length} obras. Selecione uma e clique em resumo.`;
      }catch(err){ console.error(err); status.textContent='Erro ao buscar. Verifique a conexão.' }
    }

    async function showDetails(volumeId){
      detailContent.innerHTML = 'Carregando detalhes...';
      try{
        // buscar detalhes completos
        const res = await fetch('https://www.googleapis.com/books/v1/volumes/' + encodeURIComponent(volumeId));
        const vol = await res.json();
        lastShownVolume = vol;
        const info = vol.volumeInfo || {};
        const title = info.title || 'N/D';
        const authors = info.authors ? info.authors.join(', ') : 'N/D';
        const publisher = info.publisher || 'N/D';
        const publishedDate = info.publishedDate || 'N/D';
        const year = publishedDate && publishedDate.length>=4 ? publishedDate.slice(0,4) : publishedDate;
        const edition = info?.edition || (info?.printType || 'N/D');
        const description = info.description || 'Resumo não disponível.';
        const cover = info.imageLinks && (info.imageLinks.large || info.imageLinks.thumbnail || info.imageLinks.smallThumbnail);

        detailContent.innerHTML = '';
        const titleEl = document.createElement('h3'); titleEl.textContent = title; detailContent.appendChild(titleEl);
        const authorsEl = document.createElement('div'); authorsEl.innerHTML = '<span class="label">Autor(es):</span> ' + authors; detailContent.appendChild(authorsEl);
        const pubEl = document.createElement('div'); pubEl.innerHTML = '<span class="label">Editora:</span> ' + publisher; detailContent.appendChild(pubEl);
        const edEl = document.createElement('div'); edEl.innerHTML = '<span class="label">Edição:</span> ' + edition; detailContent.appendChild(edEl);
        const yearEl = document.createElement('div'); yearEl.innerHTML = '<span class="label">Ano de publicação:</span> ' + year; detailContent.appendChild(yearEl);
        if(cover){ const img = document.createElement('img'); img.src = cover; img.alt = title + ' — capa'; img.className='cover'; detailContent.appendChild(img) }
        const desc = document.createElement('div'); desc.style.marginTop='10px'; desc.innerHTML = '<span class="label">Resumo:</span><div>' + description + '</div>'; detailContent.appendChild(desc);

        // link para a fonte (Google Books)
        const source = document.createElement('div'); source.style.marginTop='8px'; source.innerHTML = 'Fonte: <a class="source" target="_blank" rel="noopener" href="' + (vol.infoLink || ('https://books.google.com/books?id=' + encodeURIComponent(volumeId))) + '">Google Books</a>';
        detailContent.appendChild(source);
        exportBtn.disabled = false;
      }catch(err){ console.error(err); detailContent.innerHTML = 'Erro ao carregar detalhes.' }
    }

    // Exportar o último volume exibido como JSON
    function exportLastAsJSON(){
      const vol = lastShownVolume || (volumesCache[worksList.value] || null);
      if(!vol){ alert('Nenhuma obra disponível para exportar.'); return }
      const data = {
        id: vol.id,
        title: vol.volumeInfo?.title || null,
        authors: vol.volumeInfo?.authors || null,
        publisher: vol.volumeInfo?.publisher || null,
        publishedDate: vol.volumeInfo?.publishedDate || null,
        edition: vol.volumeInfo?.edition || null,
        description: vol.volumeInfo?.description || null,
        imageLinks: vol.volumeInfo?.imageLinks || null,
        source: vol.volumeInfo?.infoLink || null
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const safeTitle = (data.title || 'obra').replace(/[^a-z0-9\-_\.]/gi,'_');
      a.download = `${safeTitle}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    exportBtn.addEventListener('click', exportLastAsJSON);
  </script>
</body>
</html>

</body>
</html>

